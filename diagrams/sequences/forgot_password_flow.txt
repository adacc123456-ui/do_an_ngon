title: Quên mật khẩu – gửi OTP và đặt lại mật khẩu

participant User as "Người dùng"
participant ForgotUI as "ForgotPasswordPage"
participant AuthRepo as "AuthRepository"
participant Api as "ApiClient"
participant Backend as "Auth Service"
participant ResetUI as "ResetPasswordPage"

User->ForgotUI: Nhập email và nhấn "Gửi mã"
ForgotUI->AuthRepo: requestResetPassword(email)
AuthRepo->Api: POST /auth/forgot-password
Api->Backend: Tạo OTP và gửi email
Backend-->Api: {flowId,maskedEmail}
Api-->AuthRepo: Response
AuthRepo-->ForgotUI: flowId
ForgotUI->User: Hiển thị ô nhập OTP + nút tiếp tục

User->ForgotUI: Nhập OTP hợp lệ
ForgotUI->ResetUI: context.push('/reset-password', flowId, email)

ResetUI->User: Yêu cầu nhập mật khẩu mới + xác nhận
User->ResetUI: Nhấn "Đặt lại mật khẩu"
ResetUI->AuthRepo: confirmResetPassword(flowId,otp,newPassword)
AuthRepo->Api: POST /auth/reset-password
Api->Backend: Xác thực OTP và cập nhật mật khẩu
Backend-->Api: Success
Api-->AuthRepo: 200 OK
AuthRepo-->ResetUI: Success

alt Đặt lại thành công
  ResetUI->User: Hiển thị Snackbar "Đã đặt lại"\nChuyển về LoginPage
else OTP sai / mật khẩu yếu
  AuthRepo-->ResetUI: ApiException(message)
  ResetUI->User: Hiển thị lỗi, giữ nguyên input
end

newpage Hoạt động (PlantUML): Quên mật khẩu
@startuml
|Người dùng|
start
:Nhập email và nhấn "Gửi mã";
|Hệ thống|
:Tạo OTP, gửi email và hiển thị ô nhập mã;
|Người dùng|
:Nhập OTP, nhấn tiếp tục;
|Hệ thống|
:Kiểm tra OTP;
if (OTP hợp lệ?) then (Có)
  |Người dùng|
  :Nhập mật khẩu mới + xác nhận;
  |Hệ thống|
  :Kiểm tra độ mạnh & đặt lại mật khẩu;
  :Thông báo thành công và điều hướng về Login;
else (Không)
  :Hiển thị lỗi OTP;
  |Người dùng|
  repeat
    :Nhập lại OTP;
    |Hệ thống|
    :Kiểm tra lại;
  repeat while (Còn sai?)
endif
stop
@enduml
